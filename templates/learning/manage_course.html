{% extends "base.html" %}
{% load static %}

{% block title %}Manage: {{ course.title }} | {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Manage Course Content</h1>
            <p class="text-muted mb-0">Organize lessons for <strong>{{ course.title }}</strong></p>
        </div>
        <div>
            <a href="#" class="btn btn-outline-secondary">
                <i class="fa-solid fa-gear me-2"></i>Course Settings
            </a>
            <button class="btn btn-primary"
                    hx-get="{% url 'learning:lesson-create-for-course' course_pk=course.pk %}"
                    hx-target="#htmx-modal-dialog" 
                    hx-swap="innerHTML"
                    data-bs-toggle="modal" 
                    data-bs-target="#htmx-modal">
                <i class="fa-solid fa-plus me-2"></i>Add New Lesson
            </button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Lesson Structure</h5>
            <span class="htmx-indicator text-muted">
                <i class="fa-solid fa-spinner fa-spin me-2"></i>Saving...
            </span>
        </div>
        <div class="card-body p-0" id="lesson-list-wrapper"
             hx-post="{% url 'api:course-update-lesson-order' pk=course.pk %}"
             hx-trigger="endDrag from:#lesson-list"
             hx-indicator=".htmx-indicator"
             hx-swap="none">
            
            <div id="lesson-list-container"
                 hx-get="{% url 'learning:course-manage' course.pk %}"
                 hx-trigger="lessonListChanged from:body"
                 hx-select="#lesson-list-container"
                 hx-target="#lesson-list-container"
                 hx-swap="outerHTML">
                {% include 'partials/_lesson_list.html' with lessons=course.lessons.all %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/sortable.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const lessonList = document.getElementById('lesson-list');
    if (lessonList) {
        new Sortable(lessonList, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'bg-light',
            onEnd: function (evt) {
                const lessonIds = Array.from(evt.target.children).map(el => el.dataset.id);
                const container = htmx.find('#lesson-list-wrapper');
                htmx.trigger(container, 'endDrag', { lesson_ids: lessonIds });
            }
        });
    }
});
</script>
{% endblock %}